#!/usr/bin/env bash
# ============================================
# run_qwen â€” Cross-shell launcher with .env auto-load
# ============================================

# --- Auto-load .env variables ---
if [ -n "$BASH_VERSION" ]; then
    if [ -f ".env" ]; then
        export $(grep -v '^#' .env | xargs)
        echo "[OK] Loaded .env variables (Bash)"
    else
        echo "[WARN] No .env file found in $(pwd)"
    fi

elif [ -n "$PSModulePath" ]; then
    pwsh -NoProfile -Command "
        if (Test-Path .env) {
            Get-Content .env | ForEach-Object {
                if (\$_ -match '^\s*#') { return }
                \$name, \$value = \$_ -split '=', 2
                \$name = \$name.Trim()
                \$value = \$value.Trim()
                if (\$name) { \${env:\$name} = \$value }
            }
            Write-Host '[OK] Loaded .env variables (PowerShell)'
        } else {
            Write-Host '[WARN] No .env file found in' (Get-Location)
        }
    "
fi

# --- Fail-safe check ---
if [ -n "$BASH_VERSION" ]; then
    if [[ -z "$OPENROUTER_API_KEY" || "$OPENROUTER_API_KEY" =~ ^\ |[[:space:]]$ ]]; then
        echo "[ERROR] OPENROUTER_API_KEY is missing or has spaces. Please fix .env."
        exit 1
    fi
elif [ -n "$PSModulePath" ]; then
    pwsh -NoProfile -Command "
        if (-not \$env:OPENROUTER_API_KEY -or \$env:OPENROUTER_API_KEY -match '^\s|\s\$') {
            Write-Host '[ERROR] OPENROUTER_API_KEY is missing or has spaces. Please fix .env.'
            exit 1
        }
    "
fi

# --- Run Qwen ---
qwen "$@"
